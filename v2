import os
from pathlib import Path
import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox
from datetime import datetime

def rename_files_from_excel(excel_path, target_folder, file_ext):
    try:
        df = pd.read_excel(excel_path)
        if not {'Prefix', 'Filename'}.issubset(df.columns):
            raise ValueError("Excel must contain 'Prefix' and 'Filename' columns.")

        log_entries = []
        target_folder = Path(target_folder)

        for _, row in df.iterrows():
            prefix, base = str(row['Prefix']).strip(), str(row['Filename']).strip()
            old_name, new_name = f"{base}{file_ext}", f"{prefix}-{base}{file_ext}"
            old_path, new_path = target_folder / old_name, target_folder / new_name
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

            if old_path.is_file():
                try:
                    old_path.rename(new_path)
                    status = "Renamed"
                except Exception as e:
                    status = f"Error: {e}"
            else:
                status, new_name = "File not found", ""

            log_entries.append([timestamp, old_name, new_name, status])

        log_df = pd.DataFrame(log_entries, columns=["Timestamp", "Original Name", "New Name", "Status"])
        log_file = Path(excel_path).parent / f"rename_log_{datetime.now():%Y%m%d_%H%M%S}.xlsx"
        log_df.to_excel(log_file, index=False)

        renamed = sum(1 for _, _, _, status in log_entries if status == "Renamed")
        failed = len(log_entries) - renamed
        messagebox.showinfo("Rename Summary", f"\u2714 Files renamed: {renamed}\n\u26A0 Issues: {failed}\n\n\ud83d\udcc4 Log saved to:\n{log_file}")

    except Exception as e:
        messagebox.showerror("Error", f"An error occurred:\n{e}")

def save_excel_template():
    path = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel files", "*.xlsx")])
    if not path:
        return

    df = pd.DataFrame({"Prefix": ["1", "2"], "Filename": ["PDF-A", "PDF-B"]})
    try:
        df.to_excel(path, index=False)
        messagebox.showinfo("Template Created", f"Template saved to:\n{path}")
    except Exception as e:
        messagebox.showerror("Error", f"Could not save file:\n{e}")

def launch_gui():
    root = tk.Tk()
    root.title("File Renamer")
    root.geometry("400x200")
    root.resizable(False, False)

    file_ext = tk.StringVar(value=".pdf")

    def on_continue():
        ext = file_ext.get()
        excel_path = filedialog.askopenfilename(title="Select Excel File", filetypes=[("Excel files", "*.xlsx *.xls")])
        if not excel_path:
            return messagebox.showinfo("Cancelled", "No Excel file selected.")

        folder_path = filedialog.askdirectory(title="Select Folder with Files to Rename")
        if not folder_path:
            return messagebox.showinfo("Cancelled", "No folder selected.")

        root.withdraw()
        rename_files_from_excel(excel_path, folder_path, ext)
        root.destroy()

    tk.Label(root, text="Select file type to rename:").pack(pady=10)
    tk.OptionMenu(root, file_ext, ".pdf", ".docx", ".txt", ".xlsx", ".jpg", ".png").pack()
    tk.Button(root, text="Continue", command=on_continue).pack(pady=10)
    tk.Button(root, text="Create Excel Template", command=save_excel_template).pack(pady=5)

    root.mainloop()

if __name__ == "__main__":
    launch_gui()
