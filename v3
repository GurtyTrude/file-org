import os
from pathlib import Path
import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox
from datetime import datetime

def rename_files_from_excel(excel_path, target_folder, file_ext, mode):
    try:
        df = pd.read_excel(excel_path)
        if not {'Prefix', 'Filename'}.issubset(df.columns):
            raise ValueError("Excel must contain 'Prefix' and 'Filename' columns.")

        log_entries = []
        target_folder = Path(target_folder)

        for _, row in df.iterrows():
            prefix = str(row['Prefix']).strip()
            base = str(row['Filename']).strip()

            # Build old and new names based on dropdown mode
            old_name = base + file_ext

            if mode == "Prefix":
                # Keep original name, add prefix in front
                new_name = prefix + "-" + base + file_ext
            else:  # mode == "Replace"
                # Replace the base filename with the Prefix value
                new_name = prefix + file_ext

            old_path = target_folder / old_name
            new_path = target_folder / new_name
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

            if old_path.is_file():
                try:
                    old_path.rename(new_path)
                    status = "Renamed"
                except Exception as e:
                    status = "Error: " + str(e)
            else:
                status = "File not found"
                new_name = ""

            log_entries.append([timestamp, old_name, new_name, status])

        log_df = pd.DataFrame(
            log_entries,
            columns=["Timestamp", "Original Name", "New Name", "Status"]
        )
        log_file = Path(excel_path).parent / (
            "rename_log_" + datetime.now().strftime("%Y%m%d_%H%M%S") + ".xlsx"
        )
        log_df.to_excel(log_file, index=False)

        renamed = sum(1 for _, _, _, status in log_entries if status == "Renamed")
        failed = len(log_entries) - renamed
        messagebox.showinfo(
            "Rename Summary",
            "âœ” Files renamed: " + str(renamed)
            + "\nâš  Issues: " + str(failed)
            + "\n\nðŸ“„ Log saved to:\n" + str(log_file)
        )

    except Exception as e:
        messagebox.showerror("Error", "An error occurred:\n" + str(e))

def save_excel_template():
    path = filedialog.asksaveasfilename(
        defaultextension=".xlsx",
        filetypes=[("Excel files", "*.xlsx")]
    )
    if not path:
        return

    df = pd.DataFrame({"Prefix": ["1", "2"], "Filename": ["PDF-A", "PDF-B"]})
    try:
        df.to_excel(path, index=False)
        messagebox.showinfo("Template Created", "Template saved to:\n" + str(path))
    except Exception as e:
        messagebox.showerror("Error", "Could not save file:\n" + str(e))

def launch_gui():
    root = tk.Tk()
    root.title("File Renamer")
    root.geometry("520x260")
    root.resizable(False, False)

    file_ext = tk.StringVar(value=".pdf")
    mode_var = tk.StringVar(value="Prefix")  # Dropdown for Prefix vs Replace
    excel_path_var = tk.StringVar(value="")
    target_folder_var = tk.StringVar(value="")

    # ----- Callbacks -----

    def browse_excel():
        path = filedialog.askopenfilename(
            filetypes=[("Excel files", "*.xlsx;*.xls")]
        )
        if path:
            excel_path_var.set(path)

    def browse_folder():
        path = filedialog.askdirectory()
        if path:
            target_folder_var.set(path)

    def on_continue():
        excel_path = excel_path_var.get()
        target_folder = target_folder_var.get()
        ext = file_ext.get()
        mode = mode_var.get()

        if not excel_path or not target_folder:
            messagebox.showwarning(
                "Missing Information",
                "Please select both an Excel file and a target folder."
            )
            return

        if not ext.startswith("."):
            ext = "." + ext

        rename_files_from_excel(excel_path, target_folder, ext, mode)

    def on_quit():
        root.destroy()

    # ----- Layout -----

    padding_x = 10
    padding_y = 5

    # Excel file row
    lbl_excel = tk.Label(root, text="Excel file:")
    lbl_excel.grid(row=0, column=0, padx=padding_x, pady=padding_y, sticky="w")

    entry_excel = tk.Entry(root, textvariable=excel_path_var, width=50, state="readonly")
    entry_excel.grid(row=0, column=1, padx=padding_x, pady=padding_y, sticky="we")

    btn_excel = tk.Button(root, text="Browseâ€¦", command=browse_excel)
    btn_excel.grid(row=0, column=2, padx=padding_x, pady=padding_y)

    # Target folder row
    lbl_folder = tk.Label(root, text="Target folder:")
    lbl_folder.grid(row=1, column=0, padx=padding_x, pady=padding_y, sticky="w")

    entry_folder = tk.Entry(root, textvariable=target_folder_var, width=50, state="readonly")
    entry_folder.grid(row=1, column=1, padx=padding_x, pady=padding_y, sticky="we")

    btn_folder = tk.Button(root, text="Browseâ€¦", command=browse_folder)
    btn_folder.grid(row=1, column=2, padx=padding_x, pady=padding_y)

    # File extension row
    lbl_ext = tk.Label(root, text="File extension:")
    lbl_ext.grid(row=2, column=0, padx=padding_x, pady=padding_y, sticky="w")

    entry_ext = tk.Entry(root, textvariable=file_ext, width=10)
    entry_ext.grid(row=2, column=1, padx=padding_x, pady=padding_y, sticky="w")

    # Mode dropdown (Prefix vs Replace)
    lbl_mode = tk.Label(root, text="Use Prefix to:")
    lbl_mode.grid(row=3, column=0, padx=padding_x, pady=padding_y, sticky="w")

    mode_options = ["Prefix", "Replace"]
    dropdown_mode = tk.OptionMenu(root, mode_var, *mode_options)
    dropdown_mode.grid(row=3, column=1, padx=padding_x, pady=padding_y, sticky="w")

    # Buttons row
    btn_template = tk.Button(root, text="Save Excel Template", command=save_excel_template)
    btn_template.grid(row=4, column=0, padx=padding_x, pady=padding_y, sticky="w")

    btn_run = tk.Button(root, text="Run", command=on_continue, width=12)
    btn_run.grid(row=4, column=1, padx=padding_x, pady=padding_y, sticky="e")

    btn_quit = tk.Button(root, text="Quit", command=on_quit, width=10)
    btn_quit.grid(row=4, column=2, padx=padding_x, pady=padding_y, sticky="e")

    root.mainloop()

if __name__ == "__main__":
    launch_gui()
